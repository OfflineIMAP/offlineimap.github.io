<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>offlineimap.folder.Base &mdash; OfflineIMAP 7.1.4 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '7.1.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="OfflineIMAP 7.1.4 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OfflineIMAP 7.1.4 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for offlineimap.folder.Base</h1><div class="highlight"><pre>
<span></span><span class="c1"># Base folder support</span>
<span class="c1"># Copyright (C) 2002-2016 John Goerzen &amp; contributors</span>
<span class="c1">#</span>
<span class="c1">#    This program is free software; you can redistribute it and/or modify</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="c1">#    the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1">#    (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program; if not, write to the Free Software</span>
<span class="c1">#    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA</span>

<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">exc_info</span>

<span class="kn">from</span> <span class="nn">offlineimap</span> <span class="kn">import</span> <span class="n">threadutil</span>
<span class="kn">from</span> <span class="nn">offlineimap.ui</span> <span class="kn">import</span> <span class="n">getglobalui</span>
<span class="kn">from</span> <span class="nn">offlineimap.error</span> <span class="kn">import</span> <span class="n">OfflineImapError</span>
<span class="kn">import</span> <span class="nn">offlineimap.accounts</span>


<div class="viewcode-block" id="BaseFolder"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder">[docs]</a><span class="k">class</span> <span class="nc">BaseFolder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="fm">__hash__</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">repository</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param name: Path &amp; name of folder minus root or reference</span>
<span class="sd">        :param repository: Repository() in which the folder is.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">getglobalui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">messagelist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Save original name for folderfilter operations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffilter_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1"># Top level dir name is always &#39;&#39;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsep</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newmail_hook</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># Only set the newmail_hook if the IMAP folder is named &#39;INBOX&#39;.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;INBOX&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newmail_hook</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">newmail_hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">have_newmail</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_ignoreUIDs</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># List of UIDs to ignore.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">repository</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visiblename</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">nametrans</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># In case the visiblename becomes &#39;.&#39; or &#39;/&#39; (top-level) we use</span>
        <span class="c1"># &#39;&#39; as that is the name that e.g. the Maildir scanning will</span>
        <span class="c1"># return for the top-level dir.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visiblename</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsep</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visiblename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">repoconfname</span> <span class="o">=</span> <span class="s2">&quot;Repository &quot;</span> <span class="o">+</span> <span class="n">repository</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">getconfig</span><span class="p">()</span>

        <span class="c1"># Do we need to use mail timestamp for filename prefix?</span>
        <span class="n">filename_use_mail_timestamp_global</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getdefaultboolean</span><span class="p">(</span>
            <span class="s2">&quot;general&quot;</span><span class="p">,</span> <span class="s2">&quot;filename_use_mail_timestamp&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename_use_mail_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getdefaultboolean</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repoconfname</span><span class="p">,</span>
            <span class="s2">&quot;filename_use_mail_timestamp&quot;</span><span class="p">,</span>
            <span class="n">filename_use_mail_timestamp_global</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_deletes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getdefaultboolean</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repoconfname</span><span class="p">,</span> <span class="s2">&quot;sync_deletes&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dofsync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getdefaultboolean</span><span class="p">(</span><span class="s2">&quot;general&quot;</span><span class="p">,</span> <span class="s2">&quot;fsync&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="c1"># Determine if we&#39;re running static or dynamic folder filtering</span>
        <span class="c1"># and check filtering status.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_folderfilter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getdefaultboolean</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repoconfname</span><span class="p">,</span> <span class="s2">&quot;dynamic_folderfilter&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_this</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">should_sync_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ffilter_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_folderfilter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;Running dynamic folder filtering on &#39;</span><span class="si">%s</span><span class="s2">&#39;[</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ffilter_name</span><span class="p">,</span> <span class="n">repository</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sync_this</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;Filtering out &#39;</span><span class="si">%s</span><span class="s2">&#39;[</span><span class="si">%s</span><span class="s2">] due to folderfilter&quot;</span><span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ffilter_name</span><span class="p">,</span> <span class="n">repository</span><span class="p">))</span>

        <span class="c1"># Passes for syncmessagesto.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syncmessagesto_passes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__syncmessagesto_copy</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__syncmessagesto_delete</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__syncmessagesto_flags</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="BaseFolder.getname"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getname">[docs]</a>    <span class="k">def</span> <span class="nf">getname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</div>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># FIMXE: remove calls of this. We have getname().</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># NOTE(sheeprine): Implicit call to this by UIBase deletingflags() which</span>
        <span class="c1"># fails if the str is utf-8</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts a transaction. This will postpone (guaranteed) saving to disk</span>
<span class="sd">        of all messages saved inside this transaction until its committed.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Commits a transaction, all messages saved inside this transaction</span>
<span class="sd">        will only now be persisted to disk.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">accountname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Account name as string&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">accountname</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sync_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Should this folder be synced or is it e.g. filtered out?&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_folderfilter</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sync_this</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">should_sync_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ffilter_name</span><span class="p">)</span>

<div class="viewcode-block" id="BaseFolder.dofsync"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.dofsync">[docs]</a>    <span class="k">def</span> <span class="nf">dofsync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dofsync</span>
</div>
<div class="viewcode-block" id="BaseFolder.suggeststhreads"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.suggeststhreads">[docs]</a>    <span class="k">def</span> <span class="nf">suggeststhreads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this folder suggests using threads for actions.</span>

<span class="sd">        Only IMAP returns True. This method must honor any CLI or configuration</span>
<span class="sd">        option.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="BaseFolder.waitforthread"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.waitforthread">[docs]</a>    <span class="k">def</span> <span class="nf">waitforthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implements method that waits for thread to be usable.</span>
<span class="sd">        Should be implemented only for folders that suggest threads.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.quickchanged"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.quickchanged">[docs]</a>    <span class="k">def</span> <span class="nf">quickchanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statusfolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Runs quick check for folder changes and returns changed</span>
<span class="sd">        status: True -- changed, False -- not changed.</span>

<span class="sd">        :param statusfolder: keeps track of the last known folder state.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="BaseFolder.getinstancelimitnamespace"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getinstancelimitnamespace">[docs]</a>    <span class="k">def</span> <span class="nf">getinstancelimitnamespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For threading folders, returns the instancelimitname for</span>
<span class="sd">        InstanceLimitedThreads.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.storesmessages"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.storesmessages">[docs]</a>    <span class="k">def</span> <span class="nf">storesmessages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Should be true for any backend that actually saves message bodies.</span>
<span class="sd">        (Almost all of them).  False for the LocalStatus backend.  Saves</span>
<span class="sd">        us from having to slurp up messages just for localstatus purposes.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="BaseFolder.getvisiblename"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getvisiblename">[docs]</a>    <span class="k">def</span> <span class="nf">getvisiblename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The nametrans-transposed name of the folder&#39;s name.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visiblename</span>
</div>
<div class="viewcode-block" id="BaseFolder.getexplainedname"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getexplainedname">[docs]</a>    <span class="k">def</span> <span class="nf">getexplainedname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Name that shows both real and nametrans-mangled values.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">visiblename</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> [remote name </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visiblename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.getrepository"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getrepository">[docs]</a>    <span class="k">def</span> <span class="nf">getrepository</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the repository object that this folder is within.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span>
</div>
<div class="viewcode-block" id="BaseFolder.getroot"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getroot">[docs]</a>    <span class="k">def</span> <span class="nf">getroot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the root of the folder, in a folder-specific fashion.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
</div>
<div class="viewcode-block" id="BaseFolder.getsep"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getsep">[docs]</a>    <span class="k">def</span> <span class="nf">getsep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the separator for this folder type.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep</span>
</div>
<div class="viewcode-block" id="BaseFolder.getfullname"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getfullname">[docs]</a>    <span class="k">def</span> <span class="nf">getfullname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getroot</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsep</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseFolder.getfolderbasename"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getfolderbasename">[docs]</a>    <span class="k">def</span> <span class="nf">getfolderbasename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return base file name of file to store Status/UID info in.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Avoid directory hierarchies and file names such as &#39;/&#39;.</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="c1"># Replace with literal &#39;dot&#39; if final path name is &#39;.&#39; as &#39;.&#39; is</span>
        <span class="c1"># an invalid file name.</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;(^|\/)\.$&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">1dot&#39;</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">basename</span>
</div>
<div class="viewcode-block" id="BaseFolder.check_uidvalidity"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.check_uidvalidity">[docs]</a>    <span class="k">def</span> <span class="nf">check_uidvalidity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests if the cached UIDVALIDITY match the real current one</span>

<span class="sd">        If required it saves the UIDVALIDITY value. In this case the</span>
<span class="sd">        function is not threadsafe. So don&#39;t attempt to call it from</span>
<span class="sd">        concurrent threads.</span>

<span class="sd">        :returns: Boolean indicating the match. Returns True in case it</span>
<span class="sd">            implicitely saved the UIDVALIDITY.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_saveduidvalidity</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_saveduidvalidity</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uidvalidity</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_uidvalidity</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
</div>
    <span class="k">def</span> <span class="nf">_getuidfilename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;provides UIDVALIDITY cache filename for class internal purposes.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">getuiddir</span><span class="p">(),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">getfolderbasename</span><span class="p">())</span>

<div class="viewcode-block" id="BaseFolder.get_saveduidvalidity"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.get_saveduidvalidity">[docs]</a>    <span class="k">def</span> <span class="nf">get_saveduidvalidity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the previously cached UIDVALIDITY value</span>

<span class="sd">        :returns: UIDVALIDITY as (long) number or None, if None had been</span>
<span class="sd">            saved yet.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_base_saved_uidvalidity&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_saved_uidvalidity</span>
        <span class="n">uidfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getuidfilename</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">uidfilename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_saved_uidvalidity</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">uidfilename</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_saved_uidvalidity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_saved_uidvalidity</span>
</div>
<div class="viewcode-block" id="BaseFolder.save_uidvalidity"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.save_uidvalidity">[docs]</a>    <span class="k">def</span> <span class="nf">save_uidvalidity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the UIDVALIDITY value of the folder to the cache</span>

<span class="sd">        This function is not threadsafe, so don&#39;t attempt to call it</span>
<span class="sd">        from concurrent threads.&quot;&quot;&quot;</span>

        <span class="n">newval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uidvalidity</span><span class="p">()</span>
        <span class="n">uidfilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getuidfilename</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">uidfilename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">uidfile</span><span class="p">:</span>
            <span class="n">uidfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">newval</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">uidfilename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="n">uidfilename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_saved_uidvalidity</span> <span class="o">=</span> <span class="n">newval</span>
</div>
<div class="viewcode-block" id="BaseFolder.get_uidvalidity"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.get_uidvalidity">[docs]</a>    <span class="k">def</span> <span class="nf">get_uidvalidity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the current connections UIDVALIDITY value</span>

<span class="sd">        This function needs to be implemented by each Backend</span>
<span class="sd">        :returns: UIDVALIDITY as a (long) number.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.cachemessagelist"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.cachemessagelist">[docs]</a>    <span class="k">def</span> <span class="nf">cachemessagelist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cache the list of messages.</span>

<span class="sd">        Reads the message list from disk or network and stores it in memory for</span>
<span class="sd">        later use.  This list will not be re-read from disk or memory unless</span>
<span class="sd">        this function is called again.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.ismessagelistempty"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.ismessagelistempty">[docs]</a>    <span class="k">def</span> <span class="nf">ismessagelistempty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is the list of messages empty.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">messagelist</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="BaseFolder.dropmessagelistcache"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.dropmessagelistcache">[docs]</a>    <span class="k">def</span> <span class="nf">dropmessagelistcache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Empty everythings we know about messages.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">messagelist</span> <span class="o">=</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmessagelist"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessagelist">[docs]</a>    <span class="k">def</span> <span class="nf">getmessagelist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the current message list.</span>

<span class="sd">        You must call cachemessagelist() before calling this function!&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">messagelist</span>
</div>
<div class="viewcode-block" id="BaseFolder.msglist_item_initializer"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.msglist_item_initializer">[docs]</a>    <span class="k">def</span> <span class="nf">msglist_item_initializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns value for empty messagelist element with given UID.</span>

<span class="sd">        This function must initialize all fields of messagelist item</span>
<span class="sd">        and must be called every time when one creates new messagelist</span>
<span class="sd">        entry to ensure that all fields that must be present are present.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.uidexists"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.uidexists">[docs]</a>    <span class="k">def</span> <span class="nf">uidexists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if uid exists.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessagelist</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmessageuidlist"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessageuidlist">[docs]</a>    <span class="k">def</span> <span class="nf">getmessageuidlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets a list of UIDs.</span>

<span class="sd">        You may have to call cachemessagelist() before calling this function!&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getmessagelist</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmessagecount"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessagecount">[docs]</a>    <span class="k">def</span> <span class="nf">getmessagecount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the number of messages.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getmessagelist</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmessage"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessage">[docs]</a>    <span class="k">def</span> <span class="nf">getmessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the content of the specified message.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmaxage"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmaxage">[docs]</a>    <span class="k">def</span> <span class="nf">getmaxage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return maxage.</span>

<span class="sd">        maxage is allowed to be either an integer or a date of the form</span>
<span class="sd">        YYYY-mm-dd. This returns a time_struct.&quot;&quot;&quot;</span>

        <span class="n">maxagestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getdefault</span><span class="p">(</span><span class="s2">&quot;Account </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accountname</span><span class="p">,</span> <span class="s2">&quot;maxage&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxagestr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="c1"># Is it a number?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">maxage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxagestr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maxage</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OfflineImapError</span><span class="p">(</span><span class="s2">&quot;invalid maxage value </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">maxage</span><span class="p">,</span>
                    <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="n">maxage</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Maybe it was a date.</span>
        <span class="c1"># Is it a date string?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">maxagestr</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1900</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OfflineImapError</span><span class="p">(</span><span class="s2">&quot;maxage led to year </span><span class="si">%d</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Abort syncing.&quot;</span><span class="o">%</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OfflineImapError</span><span class="p">(</span><span class="s2">&quot;maxage led to future date </span><span class="si">%s</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Abort syncing.&quot;</span><span class="o">%</span> <span class="n">maxagestr</span><span class="p">,</span>
                    <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">date</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OfflineImapError</span><span class="p">(</span><span class="s2">&quot;invalid maxage value </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">maxagestr</span><span class="p">,</span>
                <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmaxsize"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmaxsize">[docs]</a>    <span class="k">def</span> <span class="nf">getmaxsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getdefaultint</span><span class="p">(</span><span class="s2">&quot;Account </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accountname</span><span class="p">,</span> <span class="s2">&quot;maxsize&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.getstartdate"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getstartdate">[docs]</a>    <span class="k">def</span> <span class="nf">getstartdate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve the value of the configuration option startdate &quot;&quot;&quot;</span>
        <span class="n">datestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getdefault</span><span class="p">(</span><span class="s2">&quot;Repository &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;startdate&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">datestr</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">datestr</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1900</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OfflineImapError</span><span class="p">(</span><span class="s2">&quot;startdate led to year </span><span class="si">%d</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Abort syncing.&quot;</span><span class="o">%</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OfflineImapError</span><span class="p">(</span><span class="s2">&quot;startdate led to future date </span><span class="si">%s</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Abort syncing.&quot;</span><span class="o">%</span> <span class="n">datestr</span><span class="p">,</span>
                    <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">date</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OfflineImapError</span><span class="p">(</span><span class="s2">&quot;invalid startdate value </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.get_min_uid_file"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.get_min_uid_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_min_uid_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">startuiddir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getmetadatadir</span><span class="p">(),</span>
            <span class="s1">&#39;Repository-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;StartUID&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">startuiddir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">startuiddir</span><span class="p">,</span> <span class="mi">0</span><span class="n">o700</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">startuiddir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getfolderbasename</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="BaseFolder.save_min_uid"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.save_min_uid">[docs]</a>    <span class="k">def</span> <span class="nf">save_min_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_uid</span><span class="p">):</span>
        <span class="n">uidfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_min_uid_file</span><span class="p">()</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">uidfile</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">min_uid</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseFolder.retrieve_min_uid"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.retrieve_min_uid">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_min_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">uidfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_min_uid_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">uidfile</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">uidfile</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span>
            <span class="n">min_uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">min_uid</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t read </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span> <span class="n">uidfile</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="BaseFolder.savemessage"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.savemessage">[docs]</a>    <span class="k">def</span> <span class="nf">savemessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rtime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a new message, with the specified uid.</span>

<span class="sd">        If the uid is &lt; 0: The backend should assign a new uid and</span>
<span class="sd">           return it.  In case it cannot assign a new uid, it returns</span>
<span class="sd">           the negative uid passed in WITHOUT saving the message.</span>

<span class="sd">           If the backend CAN assign a new uid, but cannot find out what</span>
<span class="sd">           this UID is (as is the case with some IMAP servers), it</span>
<span class="sd">           returns 0 but DOES save the message.</span>

<span class="sd">           IMAP backend should be the only one that can assign a new</span>
<span class="sd">           uid.</span>

<span class="sd">        If the uid is &gt; 0, the backend should set the uid to this, if it can.</span>
<span class="sd">           If it cannot set the uid to that, it will save it anyway.</span>
<span class="sd">           It will return the uid assigned in any case.</span>

<span class="sd">        Note that savemessage() does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that savemessage is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmessagetime"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessagetime">[docs]</a>    <span class="k">def</span> <span class="nf">getmessagetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the received time for the specified message.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmessagemtime"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessagemtime">[docs]</a>    <span class="k">def</span> <span class="nf">getmessagemtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the message modification time of the specified message.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmessageflags"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessageflags">[docs]</a>    <span class="k">def</span> <span class="nf">getmessageflags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the flags for the specified message.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmessagekeywords"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessagekeywords">[docs]</a>    <span class="k">def</span> <span class="nf">getmessagekeywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the keywords for the specified message.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.savemessageflags"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.savemessageflags">[docs]</a>    <span class="k">def</span> <span class="nf">savemessageflags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the specified message&#39;s flags to the given set.</span>

<span class="sd">        Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.addmessageflags"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.addmessageflags">[docs]</a>    <span class="k">def</span> <span class="nf">addmessageflags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds the specified flags to the message&#39;s flag set.</span>

<span class="sd">        If a given flag is already present, it will not be duplicated.</span>

<span class="sd">        Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.</span>

<span class="sd">        :param flags: A set() of flags&quot;&quot;&quot;</span>

        <span class="n">newflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="o">|</span> <span class="n">flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savemessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">newflags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.addmessagesflags"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.addmessagesflags">[docs]</a>    <span class="k">def</span> <span class="nf">addmessagesflags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uidlist</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">uidlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uidexists</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addmessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.deletemessageflags"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.deletemessageflags">[docs]</a>    <span class="k">def</span> <span class="nf">deletemessageflags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes each flag given from the message&#39;s flag set.</span>

<span class="sd">        Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.</span>

<span class="sd">        If a given flag is already removed, no action will be taken for that</span>
<span class="sd">        flag.&quot;&quot;&quot;</span>

        <span class="n">newflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="o">-</span> <span class="n">flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savemessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">newflags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.deletemessagesflags"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.deletemessagesflags">[docs]</a>    <span class="k">def</span> <span class="nf">deletemessagesflags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uidlist</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">uidlist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletemessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.getmessagelabels"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessagelabels">[docs]</a>    <span class="k">def</span> <span class="nf">getmessagelabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the labels for the specified message.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.savemessagelabels"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.savemessagelabels">[docs]</a>    <span class="k">def</span> <span class="nf">savemessagelabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">ignorelabels</span><span class="o">=</span><span class="nb">set</span><span class="p">(),</span> <span class="n">mtime</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the specified message&#39;s labels to the given set.</span>

<span class="sd">        Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.addmessagelabels"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.addmessagelabels">[docs]</a>    <span class="k">def</span> <span class="nf">addmessagelabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds the specified labels to the message&#39;s labels set.  If a given</span>
<span class="sd">        label is already present, it will not be duplicated.</span>

<span class="sd">        Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.</span>

<span class="sd">        :param labels: A set() of labels&quot;&quot;&quot;</span>

        <span class="n">newlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessagelabels</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="o">|</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savemessagelabels</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">newlabels</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.addmessageslabels"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.addmessageslabels">[docs]</a>    <span class="k">def</span> <span class="nf">addmessageslabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uidlist</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">uidlist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addmessagelabels</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.deletemessagelabels"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.deletemessagelabels">[docs]</a>    <span class="k">def</span> <span class="nf">deletemessagelabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes each label given from the message&#39;s label set.</span>

<span class="sd">        If a given label is already removed, no action will be taken for that</span>
<span class="sd">        label.</span>

<span class="sd">        Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="n">newlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessagelabels</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="o">-</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savemessagelabels</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">newlabels</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.deletemessageslabels"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.deletemessageslabels">[docs]</a>    <span class="k">def</span> <span class="nf">deletemessageslabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uidlist</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">uidlist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletemessagelabels</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.addmessageheader"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.addmessageheader">[docs]</a>    <span class="k">def</span> <span class="nf">addmessageheader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">linebreak</span><span class="p">,</span> <span class="n">headername</span><span class="p">,</span> <span class="n">headervalue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds new header to the provided message.</span>

<span class="sd">        WARNING: This function is a bit tricky, and modifying it in the wrong way,</span>
<span class="sd">        may easily lead to data-loss.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        - content: message content, headers and body as a single string</span>
<span class="sd">        - linebreak: string that carries line ending</span>
<span class="sd">        - headername: name of the header to add</span>
<span class="sd">        - headervalue: value of the header to add</span>

<span class="sd">        .. note::</span>

<span class="sd">           The following documentation will not get displayed correctly after being</span>
<span class="sd">           processed by Sphinx. View the source of this method to read it.</span>

<span class="sd">        This has to deal with strange corner cases where the header is</span>
<span class="sd">        missing or empty.  Here are illustrations for all the cases,</span>
<span class="sd">        showing where the header gets inserted and what the end result</span>
<span class="sd">        is.  In each illustration, &#39;+&#39; means the added contents.  Note</span>
<span class="sd">        that these examples assume LF for linebreak, not CRLF, so &#39;\n&#39;</span>
<span class="sd">        denotes a linebreak and &#39;\n\n&#39; corresponds to the transition</span>
<span class="sd">        between header and body.  However if the linebreak parameter</span>
<span class="sd">        is set to &#39;\r\n&#39; then you would have to substitute &#39;\r\n&#39; for</span>
<span class="sd">        &#39;\n&#39; in the below examples.</span>

<span class="sd">          * Case 1: No &#39;\n\n&#39;, leading &#39;\n&#39;</span>

<span class="sd">            +X-Flying-Pig-Header: i am here\n</span>
<span class="sd">            \n</span>
<span class="sd">            This is the body\n</span>
<span class="sd">            next line\n</span>

<span class="sd">          * Case 2: &#39;\n\n&#39; at position 0</span>

<span class="sd">            +X-Flying-Pig-Header: i am here</span>
<span class="sd">            \n</span>
<span class="sd">            \n</span>
<span class="sd">            This is the body\n</span>
<span class="sd">            next line\n</span>

<span class="sd">          * Case 3: No &#39;\n\n&#39;, no leading &#39;\n&#39;</span>

<span class="sd">            +X-Flying-Pig-Header: i am here\n</span>
<span class="sd">            +\n</span>
<span class="sd">            This is the body\n</span>
<span class="sd">            next line\n</span>

<span class="sd">          * Case 4: &#39;\n\n&#39; at non-zero position</span>

<span class="sd">            Subject: Something wrong with OI\n</span>
<span class="sd">            From: some@person.at</span>
<span class="sd">            +\nX-Flying-Pig-Header: i am here</span>
<span class="sd">            \n</span>
<span class="sd">            \n</span>
<span class="sd">            This is the body\n</span>
<span class="sd">            next line\n</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;addmessageheader: called to add </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>
            <span class="p">(</span><span class="n">headername</span><span class="p">,</span> <span class="n">headervalue</span><span class="p">))</span>

        <span class="n">insertionpoint</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">linebreak</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">insertionpoint</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;addmessageheader: headers were missing&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;addmessageheader: headers end at position </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span> <span class="n">insertionpoint</span><span class="p">)</span>
            <span class="n">mark</span> <span class="o">=</span> <span class="s1">&#39;==&gt;EOH&lt;==&#39;</span>
            <span class="n">contextstart</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>            <span class="n">insertionpoint</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">contextend</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">insertionpoint</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;addmessageheader: header/body transition &quot; </span><span class="se">\</span>
<span class="s1">                &quot;context (marked by </span><span class="si">%s</span><span class="s1">): </span><span class="si">%s%s%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span>
                    <span class="n">mark</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">contextstart</span><span class="p">:</span><span class="n">insertionpoint</span><span class="p">]),</span>
                    <span class="n">mark</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">insertionpoint</span><span class="p">:</span><span class="n">contextend</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Hoping for case #4.</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">linebreak</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># Case #2.</span>
        <span class="k">if</span> <span class="n">insertionpoint</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># Either case #1 or #3.</span>
        <span class="k">elif</span> <span class="n">insertionpoint</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">linebreak</span>
            <span class="n">insertionpoint</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Case #3: when body starts immediately, without preceding &#39;\n&#39;</span>
            <span class="c1"># (this shouldn&#39;t happen with proper mail messages, but</span>
            <span class="c1"># we seen many broken ones), we should add &#39;\n&#39; to make</span>
            <span class="c1"># new (and the only header, in this case) to be properly</span>
            <span class="c1"># separated from the message body.</span>
            <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">linebreak</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">linebreak</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span> <span class="o">+</span> <span class="n">linebreak</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;addmessageheader: insertionpoint = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span> <span class="n">insertionpoint</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">insertionpoint</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;addmessageheader: headers = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span>
        <span class="n">new_header</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">headername</span><span class="p">,</span> <span class="n">headervalue</span><span class="p">))</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;addmessageheader: new_header = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">new_header</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">headers</span> <span class="o">+</span> <span class="n">new_header</span> <span class="o">+</span> <span class="n">content</span><span class="p">[</span><span class="n">insertionpoint</span><span class="p">:]</span>

</div>
    <span class="k">def</span> <span class="nf">__find_eoh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Searches for the point where mail headers end.</span>

<span class="sd">        Either double &#39;\n&#39;, or end of string.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        - content: contents of the message to search in</span>
<span class="sd">        Returns: position of the first non-header byte.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">eoh_cr</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eoh_cr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">eoh_cr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">eoh_cr</span>


<div class="viewcode-block" id="BaseFolder.getmessageheader"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessageheader">[docs]</a>    <span class="k">def</span> <span class="nf">getmessageheader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value of the first occurence of the given header.</span>

<span class="sd">        Header name is case-insensitive.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        - contents: message itself</span>
<span class="sd">        - name: name of the header to be searched</span>

<span class="sd">        Returns: header value or None if no such header was found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;getmessageheader: called to get </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">eoh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find_eoh</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;getmessageheader: eoh = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span> <span class="n">eoh</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eoh</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;getmessageheader: headers = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^</span><span class="si">%s</span><span class="s1">:(.*)$&#39;</span><span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="BaseFolder.getmessageheaderlist"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.getmessageheaderlist">[docs]</a>    <span class="k">def</span> <span class="nf">getmessageheaderlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of values for the given header.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        - contents: message itself</span>
<span class="sd">        - name: name of the header to be searched</span>

<span class="sd">        Returns: list of header values or empty list if no such header was found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;getmessageheaderlist: called to get </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">eoh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find_eoh</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;getmessageheaderlist: eoh = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span> <span class="n">eoh</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eoh</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;getmessageheaderlist: headers = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;^</span><span class="si">%s</span><span class="s1">:(.*)$&#39;</span><span class="o">%</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="BaseFolder.deletemessageheaders"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.deletemessageheaders">[docs]</a>    <span class="k">def</span> <span class="nf">deletemessageheaders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">header_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes headers in the given list from the message content.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        - content: message itself</span>
<span class="sd">        - header_list: list of headers to be deleted or just the header name</span>

<span class="sd">        We expect our message to have &#39;\n&#39; as line endings.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">header_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">([]):</span>
            <span class="n">header_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">header_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;deletemessageheaders: called to delete </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">header_list</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">content</span>

        <span class="n">eoh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find_eoh</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;deletemessageheaders: end of headers = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span> <span class="n">eoh</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">eoh</span><span class="p">]</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">eoh</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;deletemessageheaders: headers = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span>
        <span class="n">new_headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">keep_it</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">trim_h</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">trim_h</span><span class="p">)</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">trim_h</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">trim_h</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
                    <span class="n">keep_it</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">keep_it</span><span class="p">:</span>
                <span class="n">new_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_headers</span><span class="p">)</span> <span class="o">+</span> <span class="n">rest</span>



</div>
<div class="viewcode-block" id="BaseFolder.change_message_uid"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.change_message_uid">[docs]</a>    <span class="k">def</span> <span class="nf">change_message_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">new_uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the message from existing uid to new_uid.</span>

<span class="sd">        If the backend supports it (IMAP does not).</span>

<span class="sd">        :param new_uid: (optional) If given, the old UID will be changed</span>
<span class="sd">            to a new UID. This allows backends efficient renaming of</span>
<span class="sd">            messages if the UID has changed.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.deletemessage"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.deletemessage">[docs]</a>    <span class="k">def</span> <span class="nf">deletemessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="BaseFolder.deletemessages"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.deletemessages">[docs]</a>    <span class="k">def</span> <span class="nf">deletemessages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uidlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">uidlist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletemessage</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseFolder.copymessageto"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.copymessageto">[docs]</a>    <span class="k">def</span> <span class="nf">copymessageto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">,</span> <span class="n">statusfolder</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copies a message from self to dst if needed, updating the status</span>

<span class="sd">        Note that this function does not check against dryrun settings,</span>
<span class="sd">        so you need to ensure that it is never called in a</span>
<span class="sd">        dryrun mode.</span>

<span class="sd">        :param uid: uid of the message to be copied.</span>
<span class="sd">        :param dstfolder: A BaseFolder-derived instance</span>
<span class="sd">        :param statusfolder: A LocalStatusFolder instance</span>
<span class="sd">        :param register: whether we should register a new thread.&quot;</span>
<span class="sd">        :returns: Nothing on success, or raises an Exception.&quot;&quot;&quot;</span>

        <span class="c1"># Sometimes, it could be the case that if a sync takes awhile,</span>
        <span class="c1"># a message might be deleted from the maildir before it can be</span>
        <span class="c1"># synced to the status cache.  This is only a problem with</span>
        <span class="c1"># self.getmessage().  So, don&#39;t call self.getmessage unless</span>
        <span class="c1"># really needed.</span>
        <span class="k">if</span> <span class="n">register</span><span class="p">:</span> <span class="c1"># Output that we start a new thread.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">registerthread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">account</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">rtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessagetime</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

            <span class="c1"># If any of the destinations actually stores the message body,</span>
            <span class="c1"># load it up.</span>
            <span class="k">if</span> <span class="n">dstfolder</span><span class="o">.</span><span class="n">storesmessages</span><span class="p">():</span>
                <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessage</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="c1"># Succeeded? -&gt; IMAP actually assigned a UID. If newid</span>
            <span class="c1"># remained negative, no server was willing to assign us an</span>
            <span class="c1"># UID. If newid is 0, saving succeeded, but we could not</span>
            <span class="c1"># retrieve the new UID. Ignore message in this case.</span>
            <span class="n">new_uid</span> <span class="o">=</span> <span class="n">dstfolder</span><span class="o">.</span><span class="n">savemessage</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rtime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_uid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_uid</span> <span class="o">!=</span> <span class="n">uid</span><span class="p">:</span>
                    <span class="c1"># Got new UID, change the local uid to match the new one.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">change_message_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">new_uid</span><span class="p">)</span>
                    <span class="n">statusfolder</span><span class="o">.</span><span class="n">deletemessage</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                    <span class="c1"># Got new UID, change the local uid.</span>
                <span class="c1"># Save uploaded status in the statusfolder.</span>
                <span class="n">statusfolder</span><span class="o">.</span><span class="n">savemessage</span><span class="p">(</span><span class="n">new_uid</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rtime</span><span class="p">)</span>
                <span class="c1"># Check whether the mail has been seen.</span>
                <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">have_newmail</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">new_uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Message was stored to dstfolder, but we can&#39;t find it&#39;s UID</span>
                <span class="c1"># This means we can&#39;t link current message to the one created</span>
                <span class="c1"># in IMAP. So we just delete local message and on next run</span>
                <span class="c1"># we&#39;ll sync it back</span>
                <span class="c1"># XXX This could cause infinite loop on syncing between two</span>
                <span class="c1"># IMAP servers ...</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deletemessage</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OfflineImapError</span><span class="p">(</span><span class="s2">&quot;Trying to save msg (uid </span><span class="si">%d</span><span class="s2">) on folder &quot;</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> returned invalid uid </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">dstfolder</span><span class="o">.</span><span class="n">getvisiblename</span><span class="p">(),</span>
                    <span class="n">new_uid</span><span class="p">),</span> <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">):</span> <span class="c1"># Bubble up CTRL-C.</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">OfflineImapError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">severity</span> <span class="o">&gt;</span> <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="c1"># Bubble severe errors up.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span>
              <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Copying message </span><span class="si">%s</span><span class="s2"> [acc: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountname</span><span class="p">))</span>
            <span class="k">raise</span>  <span class="c1"># Raise on unknown errors, so we can fix those.</span>
</div>
    <span class="k">def</span> <span class="nf">__syncmessagesto_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">,</span> <span class="n">statusfolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pass1: Copy locally existing messages not on the other side.</span>

<span class="sd">        This will copy messages to dstfolder that exist locally but are</span>
<span class="sd">        not in the statusfolder yet. The strategy is:</span>

<span class="sd">        1) Look for messages present in self but not in statusfolder.</span>
<span class="sd">        2) invoke copymessageto() on those which:</span>
<span class="sd">           - If dstfolder doesn&#39;t have it yet, add them to dstfolder.</span>
<span class="sd">           - Update statusfolder.</span>

<span class="sd">        This function checks and protects us from action in dryrun mode.&quot;&quot;&quot;</span>

        <span class="c1"># We have no new mail yet.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">have_newmail</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">copylist</span> <span class="o">=</span> <span class="p">[</span><span class="n">uid</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessageuidlist</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">statusfolder</span><span class="o">.</span><span class="n">uidexists</span><span class="p">(</span><span class="n">uid</span><span class="p">)]</span>
        <span class="n">num_to_copy</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">copylist</span><span class="p">)</span>

        <span class="c1"># Honor &#39;copy_ignore_eval&#39; configuration option.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_ignoreUIDs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_ignoreUIDs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">copylist</span><span class="p">:</span>
                    <span class="n">copylist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">ignorecopyingmessage</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_to_copy</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">dryrun</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[DRYRUN] Copy {} messages from {}[{}] to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">num_to_copy</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="n">dstfolder</span><span class="o">.</span><span class="n">repository</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">uid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">copylist</span><span class="p">):</span>
                <span class="c1"># Bail out on CTRL-C or SIGTERM.</span>
                <span class="k">if</span> <span class="n">offlineimap</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">Account</span><span class="o">.</span><span class="n">abort_NOW_signal</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Assertion that UID != 0 failed; ignoring message.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">uid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dstfolder</span><span class="o">.</span><span class="n">uidexists</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
                    <span class="c1"># dstfolder has message with that UID already, only update status.</span>
                    <span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                    <span class="n">rtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessagetime</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                    <span class="n">statusfolder</span><span class="o">.</span><span class="n">savemessage</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rtime</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">copyingmessage</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_to_copy</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">)</span>
                <span class="c1"># Exceptions are caught in copymessageto().</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggeststhreads</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">waitforthread</span><span class="p">()</span>
                    <span class="n">thread</span> <span class="o">=</span> <span class="n">threadutil</span><span class="o">.</span><span class="n">InstanceLimitedThread</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">getinstancelimitnamespace</span><span class="p">(),</span>
                        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copymessageto</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Copy message from </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="p">,</span> <span class="bp">self</span><span class="p">),</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">,</span> <span class="n">statusfolder</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">copymessageto</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">,</span> <span class="n">statusfolder</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> <span class="c1"># Block until all &quot;copy&quot; threads are done.</span>

        <span class="c1"># Execute new mail hook if we have new mail.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_newmail</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">newmail_hook</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newmail_hook</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__syncmessagesto_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">,</span> <span class="n">statusfolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pass 2: Remove locally deleted messages on dst.</span>

<span class="sd">        Get all UIDs in statusfolder but not self. These are messages</span>
<span class="sd">        that were deleted in &#39;self&#39;. Delete those from dstfolder and</span>
<span class="sd">        statusfolder.</span>

<span class="sd">        This function checks and protects us from action in dryrun mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The list of messages to delete. If sync of deletions is disabled we</span>
        <span class="c1"># still remove stale entries from statusfolder (neither in local nor</span>
        <span class="c1"># remote).</span>
        <span class="n">deletelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">uid</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">statusfolder</span><span class="o">.</span><span class="n">getmessageuidlist</span><span class="p">()</span>
                      <span class="k">if</span> <span class="n">uid</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                      <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">uidexists</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="ow">and</span>
                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sync_deletes</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dstfolder</span><span class="o">.</span><span class="n">uidexists</span><span class="p">(</span><span class="n">uid</span><span class="p">))]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deletelist</span><span class="p">):</span>
            <span class="c1"># Delete in statusfolder first to play safe. In case of abort, we</span>
            <span class="c1"># won&#39;t lose message, we will just unneccessarily retransmit some.</span>
            <span class="c1"># Delete messages from statusfolder that were either deleted by the</span>
            <span class="c1"># user, or not being tracked (e.g. because of maxage).</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">dryrun</span><span class="p">:</span>
                <span class="n">statusfolder</span><span class="o">.</span><span class="n">deletemessages</span><span class="p">(</span><span class="n">deletelist</span><span class="p">)</span>
            <span class="c1"># Filter out untracked messages.</span>
            <span class="n">deletelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">uid</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">deletelist</span> <span class="k">if</span> <span class="n">dstfolder</span><span class="o">.</span><span class="n">uidexists</span><span class="p">(</span><span class="n">uid</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deletelist</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">deletingmessages</span><span class="p">(</span><span class="n">deletelist</span><span class="p">,</span> <span class="p">[</span><span class="n">dstfolder</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">dryrun</span><span class="p">:</span>
                    <span class="n">dstfolder</span><span class="o">.</span><span class="n">deletemessages</span><span class="p">(</span><span class="n">deletelist</span><span class="p">)</span>

<div class="viewcode-block" id="BaseFolder.combine_flags_and_keywords"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.combine_flags_and_keywords">[docs]</a>    <span class="k">def</span> <span class="nf">combine_flags_and_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine the message&#39;s flags and keywords using the mapping for the</span>
<span class="sd">        destination folder.&quot;&quot;&quot;</span>

        <span class="c1"># Take a copy of the message flag set, otherwise</span>
        <span class="c1"># __syncmessagesto_flags() will fail because statusflags is actually a</span>
        <span class="c1"># reference to selfflags (which it should not, but I don&#39;t have time to</span>
        <span class="c1"># debug THAT).</span>
        <span class="n">selfflags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getmessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">keywordmap</span> <span class="o">=</span> <span class="n">dstfolder</span><span class="o">.</span><span class="n">getrepository</span><span class="p">()</span><span class="o">.</span><span class="n">getkeywordmap</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">keywordmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">selfflags</span>

            <span class="n">knownkeywords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keywordmap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">selfkeywords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessagekeywords</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">knownkeywords</span> <span class="o">&gt;=</span> <span class="n">selfkeywords</span><span class="p">:</span>
                <span class="c1"># Some of the message&#39;s keywords are not in the mapping, so</span>
                <span class="c1"># skip them.</span>
                <span class="n">skipped_keywords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selfkeywords</span> <span class="o">-</span> <span class="n">knownkeywords</span><span class="p">)</span>
                <span class="n">selfkeywords</span> <span class="o">&amp;=</span> <span class="n">knownkeywords</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown keywords skipped: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;You may want to change your configuration to include &quot;</span>
                    <span class="s2">&quot;those</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skipped_keywords</span><span class="p">))</span>

            <span class="n">keywordletterset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">keywordmap</span><span class="p">[</span><span class="n">keyw</span><span class="p">]</span> <span class="k">for</span> <span class="n">keyw</span> <span class="ow">in</span> <span class="n">selfkeywords</span><span class="p">])</span>

            <span class="c1"># Add the mapped keywords to the list of message flags.</span>
            <span class="n">selfflags</span> <span class="o">|=</span> <span class="n">keywordletterset</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">selfflags</span>
</div>
    <span class="k">def</span> <span class="nf">__syncmessagesto_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">,</span> <span class="n">statusfolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pass 3: Flag synchronization.</span>

<span class="sd">        Compare flag mismatches in self with those in statusfolder. If</span>
<span class="sd">        msg has a valid UID and exists on dstfolder (has not e.g. been</span>
<span class="sd">        deleted there), sync the flag change to both dstfolder and</span>
<span class="sd">        statusfolder.</span>

<span class="sd">        This function checks and protects us from action in ryrun mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># For each flag, we store a list of uids to which it should be</span>
        <span class="c1"># added.  Then, we can call addmessagesflags() to apply them in</span>
        <span class="c1"># bulk, rather than one call per message.</span>
        <span class="n">addflaglist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">delflaglist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmessageuidlist</span><span class="p">():</span>
            <span class="c1"># Ignore messages with negative UIDs missed by pass 1 and</span>
            <span class="c1"># don&#39;t do anything if the message has been deleted remotely</span>
            <span class="k">if</span> <span class="n">uid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dstfolder</span><span class="o">.</span><span class="n">uidexists</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">statusfolder</span><span class="o">.</span><span class="n">uidexists</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
                <span class="n">statusflags</span> <span class="o">=</span> <span class="n">statusfolder</span><span class="o">.</span><span class="n">getmessageflags</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">statusflags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="n">selfflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_flags_and_keywords</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">)</span>

            <span class="n">addflags</span> <span class="o">=</span> <span class="n">selfflags</span> <span class="o">-</span> <span class="n">statusflags</span>
            <span class="n">delflags</span> <span class="o">=</span> <span class="n">statusflags</span> <span class="o">-</span> <span class="n">selfflags</span>

            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">addflags</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">addflaglist</span><span class="p">:</span>
                    <span class="n">addflaglist</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">addflaglist</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">delflags</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">delflaglist</span><span class="p">:</span>
                    <span class="n">delflaglist</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">delflaglist</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">flag</span><span class="p">,</span> <span class="n">uids</span> <span class="ow">in</span> <span class="n">addflaglist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">addingflags</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">dryrun</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c1"># Don&#39;t actually add in a dryrun.</span>
            <span class="n">dstfolder</span><span class="o">.</span><span class="n">addmessagesflags</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
            <span class="n">statusfolder</span><span class="o">.</span><span class="n">addmessagesflags</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">flag</span><span class="p">,</span> <span class="n">uids</span> <span class="ow">in</span> <span class="n">delflaglist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">deletingflags</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">dryrun</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c1"># Don&#39;t actually remove in a dryrun.</span>
            <span class="n">dstfolder</span><span class="o">.</span><span class="n">deletemessagesflags</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
            <span class="n">statusfolder</span><span class="o">.</span><span class="n">deletemessagesflags</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>

<div class="viewcode-block" id="BaseFolder.syncmessagesto"><a class="viewcode-back" href="../../../repository.html#offlineimap.folder.Base.BaseFolder.syncmessagesto">[docs]</a>    <span class="k">def</span> <span class="nf">syncmessagesto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dstfolder</span><span class="p">,</span> <span class="n">statusfolder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Syncs messages in this folder to the destination dstfolder.</span>

<span class="sd">        This is the high level entry for syncing messages in one direction.</span>
<span class="sd">        Syncsteps are:</span>

<span class="sd">        Pass1: Copy locally existing messages</span>
<span class="sd">         Copy messages in self, but not statusfolder to dstfolder if not</span>
<span class="sd">         already in dstfolder. dstfolder might assign a new UID (e.g. if</span>
<span class="sd">         uploading to IMAP). Update statusfolder.</span>

<span class="sd">        Pass2: Remove locally deleted messages</span>
<span class="sd">         Get all UIDS in statusfolder but not self. These are messages</span>
<span class="sd">         that were deleted in &#39;self&#39;. Delete those from dstfolder and</span>
<span class="sd">         statusfolder.</span>

<span class="sd">         After this pass, the message lists should be identical wrt the</span>
<span class="sd">         uids present (except for potential negative uids that couldn&#39;t</span>
<span class="sd">         be placed anywhere).</span>

<span class="sd">        Pass3: Synchronize flag changes</span>
<span class="sd">         Compare flag mismatches in self with those in statusfolder. If</span>
<span class="sd">         msg has a valid UID and exists on dstfolder (has not e.g. been</span>
<span class="sd">         deleted there), sync the flag change to both dstfolder and</span>
<span class="sd">         statusfolder.</span>

<span class="sd">        Pass4: Synchronize label changes (Gmail only)</span>
<span class="sd">         Compares label mismatches in self with those in statusfolder.</span>
<span class="sd">         If msg has a valid UID and exists on dstfolder, syncs the labels</span>
<span class="sd">         to both dstfolder and statusfolder.</span>

<span class="sd">        :param dstfolder: Folderinstance to sync the msgs to.</span>
<span class="sd">        :param statusfolder: LocalStatus instance to sync against.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">syncmessagesto_passes</span><span class="p">:</span>
            <span class="c1"># Bail out on CTRL-C or SIGTERM.</span>
            <span class="k">if</span> <span class="n">offlineimap</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">Account</span><span class="o">.</span><span class="n">abort_NOW_signal</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">action</span><span class="p">(</span><span class="n">dstfolder</span><span class="p">,</span> <span class="n">statusfolder</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="n">OfflineImapError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">severity</span> <span class="o">&gt;</span> <span class="n">OfflineImapError</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">FOLDER</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;while syncing </span><span class="si">%s</span><span class="s2"> [account </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="o">%</span>
                                                <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountname</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;while syncing </span><span class="si">%s</span><span class="s2"> [account </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="o">%</span>
                                                <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountname</span><span class="p">))</span>
                <span class="k">raise</span> <span class="c1"># Raise unknown Exceptions so we can fix them.</span>
</div>
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Comparisons work either on string comparing folder names or</span>
<span class="sd">        on the same instance.</span>

<span class="sd">        MailDirFolder(&#39;foo&#39;) == &#39;foo&#39; --&gt; True</span>
<span class="sd">        a = MailDirFolder(&#39;foo&#39;); a == b --&gt; True</span>
<span class="sd">        MailDirFolder(&#39;foo&#39;) == &#39;moo&#39; --&gt; False</span>
<span class="sd">        MailDirFolder(&#39;foo&#39;) == IMAPFolder(&#39;foo&#39;) --&gt; False</span>
<span class="sd">        MailDirFolder(&#39;foo&#39;) == MaildirFolder(&#39;foo&#39;) --&gt; False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OfflineIMAP 7.1.4 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright Copyright 2002-2017 John Goerzen &amp; contributors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>